// ìƒìˆ˜ ì •ì˜
const CONSTANTS = {
  ANIMATION_DURATION: 1000,
  ERROR_DELAY_STEP: 0.1,
  NEXT_PAGE_URL: "/fortune.html",
  STORAGE_KEYS: {
    USER_DATA: "userFormData",
    SELECTION_DATA: "selectionData",
    FORTUNE_RESULT_DATA: "fortuneResultData",
  },
};

// DOM ìš”ì†Œ ìºì‹±
const elements = {
  form: null,
  logoText: null,
  aiInputs: null,
  fortuneInputs: null,
  periodInputs: null,
  containers: {
    ai: null,
    fortune: null,
    period: null,
    button: null,
  },
};

let userData = null;

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
const utils = {
  // ì•ˆì „í•œ 2ìë¦¬ íŒ¨ë”©
  padZero: (str) => (str.length === 1 ? "0" + str : str),

  // ì•ˆì „í•œ sessionStorage ì½ê¸°
  getStorageData: (key) => {
    try {
      const stored = sessionStorage.getItem(key);
      return stored ? JSON.parse(stored) : null;
    } catch (e) {
      console.error(`${key} íŒŒì‹± ì‹¤íŒ¨:`, e);
      return null;
    }
  },

  // ì•ˆì „í•œ sessionStorage ì €ì¥
  setStorageData: (key, data) => {
    try {
      sessionStorage.setItem(key, JSON.stringify(data));
      return true;
    } catch (e) {
      console.error(`${key} ì €ì¥ ì‹¤íŒ¨:`, e);
      return false;
    }
  },
};

// ì—ëŸ¬ ê´€ë¦¬ì
const ErrorManager = {
  container: null,

  show(messages) {
    this.hide(); // ê¸°ì¡´ ì—ëŸ¬ ì œê±°

    if (!messages.length) return;

    this.container = document.createElement("div");
    this.container.className = "error-container";

    messages.forEach((message, index) => {
      const errorDiv = document.createElement("div");
      errorDiv.className = "error-message";
      errorDiv.textContent = message;
      errorDiv.style.animationDelay = `${index * CONSTANTS.ERROR_DELAY_STEP}s`;
      this.container.appendChild(errorDiv);
    });

    // ì•ˆì „í•œ DOM ì‚½ì…
    if (elements.containers.button?.parentNode) {
      elements.containers.button.parentNode.insertBefore(
        this.container,
        elements.containers.button
      );
    }
  },

  hide() {
    if (this.container) {
      this.container.remove();
      this.container = null;
    }
  },
};

// ì• ë‹ˆë©”ì´ì…˜ ê´€ë¦¬ì
const AnimationManager = {
  timers: new Map(),

  applyError(element, animationClass) {
    if (!element) return;

    // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
    if (this.timers.has(element)) {
      clearTimeout(this.timers.get(element));
    }

    element.classList.add(animationClass);

    const timer = setTimeout(() => {
      element.classList.remove(animationClass);
      this.timers.delete(element);
    }, CONSTANTS.ANIMATION_DURATION);

    this.timers.set(element, timer);
  },

  cleanup() {
    this.timers.forEach((timer) => clearTimeout(timer));
    this.timers.clear();
  },
};

// í¼ ê²€ì¦ê¸°
const FormValidator = {
  validate() {
    const errors = [];

    // AI ì„ íƒ í™•ì¸
    const selectedAI = elements.aiInputs?.querySelector(":checked");
    if (!selectedAI) {
      errors.push("ğŸ¤– AIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
      AnimationManager.applyError(elements.containers.ai, "field-error-jump");
    }

    // ìš´ì„¸ ì¢…ë¥˜ ì„ íƒ í™•ì¸
    const selectedFortunes =
      elements.fortuneInputs?.querySelectorAll(":checked");
    if (!selectedFortunes?.length) {
      errors.push("ğŸ€ ìµœì†Œ í•˜ë‚˜ì˜ ìš´ì„¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
      AnimationManager.applyError(
        elements.containers.fortune,
        "field-error-jump"
      );
    }

    // ìš´ì„¸ ì£¼ê¸° ì„ íƒ í™•ì¸
    const selectedPeriod = elements.periodInputs?.querySelector(":checked");
    if (!selectedPeriod) {
      errors.push("ğŸ“Š ìš´ì„¸ ì£¼ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
      AnimationManager.applyError(
        elements.containers.period,
        "field-error-jump"
      );
    }

    return {
      isValid: errors.length === 0,
      errors: errors,
    };
  },
};

// ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateUserDisplay() {
  userData = utils.getStorageData(CONSTANTS.STORAGE_KEYS.USER_DATA);

  if (!userData || !elements.logoText) {
    window.location.href = "/";
    return;
  }

  const genderText = userData.gender === "male" ? "ë‚¨ì„±" : "ì—¬ì„±";

  const calendarMap = {
    solar: "ì–‘ë ¥",
    lunar: "ìŒë ¥(í‰ë‹¬)",
    lunar_leap: "ìŒë ¥(ìœ¤ë‹¬)",
  };
  const calendarText = calendarMap[userData.calendar] || "ì–‘ë ¥";

  const formattedMonth = utils.padZero(userData.month);
  const formattedDay = utils.padZero(userData.day);

  elements.logoText.innerHTML = `${
    userData.city
  } ${genderText} ${calendarText}<br>${
    userData.year
  }ë…„ ${formattedMonth}ì›” ${formattedDay}ì¼${
    userData.time ? " " + userData.time : ""
  }`;
}

// í¼ ë°ì´í„° ìˆ˜ì§‘ ë° ì €ì¥
async function handleFormSubmit() {
  const selectedAI = elements.aiInputs?.querySelector(":checked")?.value;
  const selectedFortunes = Array.from(
    elements.fortuneInputs?.querySelectorAll(":checked") || []
  ).map((input) => input.value);
  const selectedPeriod =
    elements.periodInputs?.querySelector(":checked")?.value;

  const requestData = {
    userInfo: userData,
    ai: selectedAI,
    fortunes: selectedFortunes,
    period: selectedPeriod,
  };

  try {
    const response = await fetch("/api/v1/fortune/generate", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify(requestData),
    });

    if (!response.ok) {
      ErrorManager.show(["ìš´ì„¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."]);
      return;
    }

    const fortuneResult = await response.json();

    // ê²°ê³¼ë¥¼ ì„¸ì…˜ì— ì €ì¥í•˜ê³  í˜ì´ì§€ ì´ë™
    utils.setStorageData(CONSTANTS.STORAGE_KEYS.SELECTION_DATA, {
      ai: selectedAI,
      fortunes: selectedFortunes,
      period: selectedPeriod,
    });
    utils.setStorageData(
      CONSTANTS.STORAGE_KEYS.FORTUNE_RESULT_DATA,
      fortuneResult
    );
    window.location.href = CONSTANTS.NEXT_PAGE_URL;
  } catch (error) {
    ErrorManager.show(["ìš´ì„¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."]);
  }
}

// DOM ìš”ì†Œ ì´ˆê¸°í™”
function initializeElements() {
  elements.form = document.querySelector("form");
  elements.logoText = document.querySelector(".logo p");
  elements.aiInputs = document.querySelector(".ai-cards");
  elements.fortuneInputs = document.querySelector(".fortune-grid");
  elements.periodInputs = document.querySelector(".period-cards");

  elements.containers.ai = document.querySelector(".ai-cards");
  elements.containers.fortune = document.querySelector(".fortune-grid");
  elements.containers.period = document.querySelector(".period-cards");
  elements.containers.button = document.querySelector(".retro-btn-container");
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
function attachEventListeners() {
  // í¼ ì œì¶œ ì´ë²¤íŠ¸
  if (elements.form) {
    elements.form.addEventListener("submit", function (e) {
      e.preventDefault();

      const validation = FormValidator.validate();

      if (validation.isValid) {
        handleFormSubmit();
      } else {
        ErrorManager.show(validation.errors);
      }
    });
  }

  // ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•œ ì…ë ¥ ë³€ê²½ ê°ì§€
  document.addEventListener("change", function (e) {
    const inputName = e.target.name;

    // ëª¨ë“  í¼ ì…ë ¥ì— ëŒ€í•´ ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
    if (["ai", "fortune", "period"].includes(inputName)) {
      ErrorManager.hide();
    }

    // ìš´ì„¸ ì„ íƒ ì¹´ìš´íŒ… (í•„ìš”ì‹œ)
    if (inputName === "fortune") {
      const selectedCount = document.querySelectorAll(
        'input[name="fortune"]:checked'
      ).length;
      // console.log(`${selectedCount}ê°œì˜ ìš´ì„¸ê°€ ì„ íƒë¨`); // í•„ìš”ì‹œ ì£¼ì„ í•´ì œ
    }
  });
}

// í˜ì´ì§€ ì´ˆê¸°í™”
function initializePage() {
  initializeElements();
  updateUserDisplay();
  attachEventListeners();
}

// DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initializePage);
} else {
  initializePage();
}

// í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
window.addEventListener("beforeunload", () => {
  AnimationManager.cleanup();
});
